{% extends "base.html" %}

{% block styles %}
<style>
    .ip-address-width {
        width: 200px !important;
    }
    .array-item {
        display: flex;
        align-items: center;
    }
    .array-item .form-control {
        margin-right: 0;
    }
    .array-item .btn-danger {
        padding: 0.25rem 0.5rem;
    }
    .template-section {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
    }
    .template-section:last-child {
        border-bottom: none;
    }
    .template-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        border-left: 4px solid #0d6efd;
        font-weight: 600;
        color: #2c3e50;
    }
    .interface-divider {
        margin: 1rem 0;
        border-top: 1px solid #dee2e6;
    }
    .interface-item {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Git Sync Button -->
        <div class="col-12 mb-3">
            <button id="syncButton" class="btn btn-primary">
                <i class="fas fa-sync"></i> Sync with GitLab
            </button>
            <span id="syncStatus" class="ml-2"></span>
        </div>
    </div>

    <div class="row">
        <!-- Node Structure -->
        <div class="col-1">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Family</h6>
                </div>
                <div class="card-body p-0">
                    <div id="nodeFamilyList" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>

        <div class="col-1">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Class</h6>
                </div>
                <div class="card-body p-0">
                    <div id="nodeClassList" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>

        <div class="col-2">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Node Name</h6>
                </div>
                <div class="card-body p-0">
                    <div id="nodeNameList" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>

        <!-- Templates -->
        <div class="col-2">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Templates</h6>
                </div>
                <div class="card-body p-0">
                    <div id="templateList" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>

        <!-- Variables -->
        <div class="col-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Variables</h6>
                </div>
                <div class="card-body">
                    <div id="variableList"></div>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="col-2">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Preview</h6>
                </div>
                <div class="card-body">
                    <pre id="configPreview" class="pre-scrollable"></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPath = {
    family: null,
    class: null,
    node: null,
    templates: []
};

// Add a global variable to track hidden interfaces
let hiddenInterfaces = new Set();

// Load initial structure
function loadStructure() {
    fetch('{{ url_for("config.get_structure") }}')
        .then(response => response.json())
        .then(data => {
            const familyList = document.getElementById('nodeFamilyList');
            familyList.innerHTML = '';
            
            data.families.forEach(family => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action py-2';
                item.textContent = family.name;
                item.onclick = () => selectFamily(family);
                familyList.appendChild(item);
            });
        });
}

// Select node family
function selectFamily(family) {
    currentPath.family = family.name;
    currentPath.class = null;
    currentPath.node = null;
    currentPath.templates = [];
    
    // Update UI
    document.querySelectorAll('#nodeFamilyList a').forEach(a => 
        a.classList.toggle('active', a.textContent === family.name));
    
    // Update class list
    const classList = document.getElementById('nodeClassList');
    classList.innerHTML = '';
    
    family.classes.forEach(nodeClass => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action py-2';
        item.textContent = nodeClass.name;
        item.onclick = () => selectClass(nodeClass);
        classList.appendChild(item);
    });
    
    // Clear subsequent lists
    document.getElementById('nodeNameList').innerHTML = '';
    document.getElementById('templateList').innerHTML = '';
    document.getElementById('variableList').innerHTML = '';
    document.getElementById('configPreview').textContent = '';
}

// Select node class
function selectClass(nodeClass) {
    currentPath.class = nodeClass.name;
    currentPath.node = null;
    currentPath.templates = [];
    
    // Update UI
    document.querySelectorAll('#nodeClassList a').forEach(a => 
        a.classList.toggle('active', a.textContent === nodeClass.name));
    
    // Update node list
    const nodeList = document.getElementById('nodeNameList');
    nodeList.innerHTML = '';
    
    nodeClass.nodes.forEach(node => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action py-2';
        item.textContent = node.name;
        item.onclick = () => selectNode(node);
        nodeList.appendChild(item);
    });
    
    // Clear subsequent lists
    document.getElementById('templateList').innerHTML = '';
    document.getElementById('variableList').innerHTML = '';
    document.getElementById('configPreview').textContent = '';
}

// Select node
function selectNode(node) {
    logger.debug('node-selection', 'Selecting node', { node });
    
    currentPath.node = node.name;
    currentPath.templates = [];
    hiddenInterfaces.clear();
    
    // Update UI
    document.querySelectorAll('#nodeNameList a').forEach(a => 
        a.classList.toggle('active', a.textContent === node.name));
    
    // Load templates
    fetch(`{{ url_for("config.get_templates", node_path="") }}${node.path}`)
        .then(response => response.json())
        .then(templates => {
            logger.debug('templates', 'Loading templates', { templates });
            
            const templateList = document.getElementById('templateList');
            templateList.innerHTML = '';
            
            templates.forEach(template => {
                const item = document.createElement('div');
                item.className = 'list-group-item py-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'me-2';
                checkbox.dataset.template = template.name;
                checkbox.onchange = () => {
                    const templateName = checkbox.dataset.template;
                    logger.debug('template-selection', 'Template checkbox changed', {
                        template: templateName,
                        checked: checkbox.checked
                    });
                    
                    if (checkbox.checked) {
                        if (!currentPath.templates.includes(templateName)) {
                            currentPath.templates.push(templateName);
                            logger.info('template-selection', 'Template added', { template: templateName });
                        }
                    } else {
                        const idx = currentPath.templates.indexOf(templateName);
                        if (idx !== -1) {
                            currentPath.templates.splice(idx, 1);
                            logger.info('template-selection', 'Template removed', { template: templateName });
                        }
                    }
                    refreshTemplateState();
                };
                
                const label = document.createElement('label');
                label.className = 'mb-0';
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(template.name));
                
                if (template.warning) {
                    const warning = document.createElement('i');
                    warning.className = 'fas fa-exclamation-triangle text-warning ms-2';
                    warning.title = template.warning;
                    label.appendChild(warning);
                }
                
                item.appendChild(label);
                templateList.appendChild(item);
            });
        })
        .catch(error => {
            logger.error('templates', 'Failed to load templates', { error: error.message });
        });
}

// Create form elements for complex data types
function createComplexDataInput(key, value, template, parentPath = '') {
    const container = document.createElement('div');
    container.className = 'complex-data mb-3';

    if (Array.isArray(value)) {
        // Handle array type
        const arrayContainer = document.createElement('div');
        arrayContainer.className = 'array-container';
        
        value.forEach((item, index) => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'array-item mb-2';
            
            if (typeof item === 'object' && item !== null) {
                // Complex array item (object)
                const itemDiv = document.createElement('div');
                itemDiv.className = 'interface-item';
                
                // Create a local copy of the interface data
                let interfaceData = {...item};
                
                Object.entries(interfaceData).forEach(([itemKey, itemValue]) => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'row mb-2 align-items-center';
                    
                    const labelCol = document.createElement('div');
                    labelCol.className = 'col-4';
                    const label = document.createElement('label');
                    label.className = 'mb-0';
                    label.textContent = itemKey;
                    labelCol.appendChild(label);
                    
                    const inputCol = document.createElement('div');
                    inputCol.className = 'col-8';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.value = itemValue;
                    input.onchange = () => {
                        interfaceData[itemKey] = input.value;
                        const newArray = [...value];
                        newArray[index] = interfaceData;
                        updateVariable(template, key, newArray);
                    };
                    inputCol.appendChild(input);
                    
                    formGroup.appendChild(labelCol);
                    formGroup.appendChild(inputCol);
                    itemDiv.appendChild(formGroup);
                });
                
                // Add button container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'mt-2';
                
                // Add hide/show button
                const hideBtn = document.createElement('button');
                hideBtn.className = 'btn btn-sm btn-warning';
                hideBtn.innerHTML = hiddenInterfaces.has(index) ? 
                    '<i class="fas fa-eye"></i> Show in Preview' : 
                    '<i class="fas fa-eye-slash"></i> Hide from Preview';
                itemContainer.style.opacity = hiddenInterfaces.has(index) ? '0.5' : '1';
                
                hideBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const isHidden = hiddenInterfaces.has(index);
                    
                    if (isHidden) {
                        hiddenInterfaces.delete(index);
                        itemContainer.style.opacity = '1';
                        hideBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide from Preview';
                    } else {
                        hiddenInterfaces.add(index);
                        itemContainer.style.opacity = '0.5';
                        hideBtn.innerHTML = '<i class="fas fa-eye"></i> Show in Preview';
                    }
                    
                    // Create a filtered copy of the interfaces for preview
                    const visibleInterfaces = value.filter((_, i) => !hiddenInterfaces.has(i));
                    updatePreviewOnly(template, key, visibleInterfaces);
                };
                buttonContainer.appendChild(hideBtn);
                
                itemDiv.appendChild(buttonContainer);
                itemContainer.appendChild(itemDiv);
            } else {
                // Simple array item
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex-grow-1';
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control ip-address-width';
                input.value = item;
                input.onchange = () => {
                    const newArray = [...value];
                    newArray[index] = input.value;
                    updateVariable(template, key, newArray);
                };
                inputWrapper.appendChild(input);
                itemContainer.appendChild(inputWrapper);
                
                // Add hide/show button
                const hideBtn = document.createElement('button');
                hideBtn.className = 'btn btn-sm btn-warning ms-2';
                hideBtn.innerHTML = hiddenInterfaces.has(index) ? 
                    '<i class="fas fa-eye"></i>' : 
                    '<i class="fas fa-eye-slash"></i>';
                itemContainer.style.opacity = hiddenInterfaces.has(index) ? '0.5' : '1';
                
                hideBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const isHidden = hiddenInterfaces.has(index);
                    
                    if (isHidden) {
                        hiddenInterfaces.delete(index);
                        itemContainer.style.opacity = '1';
                        hideBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    } else {
                        hiddenInterfaces.add(index);
                        itemContainer.style.opacity = '0.5';
                        hideBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    }
                    
                    // Create a filtered copy of the interfaces for preview
                    const visibleInterfaces = value.filter((_, i) => !hiddenInterfaces.has(i));
                    updatePreviewOnly(template, key, visibleInterfaces);
                };
                itemContainer.appendChild(hideBtn);
            }
            
            arrayContainer.appendChild(itemContainer);
            
            // Add divider if not the last item
            if (index < value.length - 1) {
                const divider = document.createElement('hr');
                divider.className = 'interface-divider';
                arrayContainer.appendChild(divider);
            }
        });
        
        // Add new item button at the bottom
        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-sm btn-primary mt-3';
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Add New Interface';
        addBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const newItem = Array.isArray(value) && value.length > 0 ? 
                (typeof value[0] === 'object' ? {} : '') : {};
            const newArray = [...value, newItem];
            updateVariable(template, key, newArray);
        };
        
        container.appendChild(arrayContainer);
        container.appendChild(addBtn);
    } else if (typeof value === 'object' && value !== null) {
        // Handle object type
        const objectContainer = document.createElement('div');
        objectContainer.className = 'ps-3 border-start';
        
        Object.entries(value).forEach(([objKey, objValue]) => {
            const fullPath = `${parentPath}${key}.${objKey}`;
            const formGroup = document.createElement('div');
            formGroup.className = 'row mb-2 align-items-center';
            
            const labelCol = document.createElement('div');
            labelCol.className = 'col-4';
            const label = document.createElement('label');
            label.className = 'mb-0';
            label.textContent = objKey;
            labelCol.appendChild(label);
            
            const inputCol = document.createElement('div');
            inputCol.className = 'col-8';
            
            if (typeof objValue === 'object' && objValue !== null) {
                inputCol.appendChild(createComplexDataInput(objKey, objValue, template, `${key}.`));
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.value = objValue;
                input.onchange = () => {
                    const newObj = {...value, [objKey]: input.value};
                    updateVariable(template, key, newObj);
                };
                inputCol.appendChild(input);
            }
            
            formGroup.appendChild(labelCol);
            formGroup.appendChild(inputCol);
            objectContainer.appendChild(formGroup);
        });
        
        container.appendChild(objectContainer);
    }
    
    return container;
}

// Add function to refresh template state and preview
function refreshTemplateState() {
    const nodePath = `${currentPath.family}/${currentPath.class}/${currentPath.node}`;
    const variableList = document.getElementById('variableList');
    variableList.innerHTML = '';
    
    logger.debug('template-state', 'Refreshing template state', {
        nodePath,
        selectedTemplates: currentPath.templates
    });
    
    if (currentPath.templates.length === 0) {
        document.getElementById('configPreview').textContent = '';
        logger.info('template-state', 'No templates selected, clearing preview');
        return;
    }
    
    // Load variables for all selected templates
    Promise.all(currentPath.templates.map(template =>
        fetch(`{{ url_for("config.get_variables", node_path="", template_name="") }}${nodePath}/${template}`)
            .then(response => response.json())
    )).then(variableSets => {
        logger.debug('template-state', 'Loaded variables for templates', {
            templates: currentPath.templates,
            variableSets
        });
        
        variableSets.forEach((variables, idx) => {
            const template = currentPath.templates[idx];
            const section = document.createElement('div');
            section.className = 'template-section';
            
            const title = document.createElement('div');
            title.className = 'template-header';
            title.textContent = template;
            section.appendChild(title);
            
            Object.entries(variables).forEach(([key, value]) => {
                if (typeof value === 'object' && value !== null) {
                    // Complex data type
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'mb-2';
                    const label = document.createElement('label');
                    label.className = 'fw-bold';
                    label.textContent = key;
                    labelDiv.appendChild(label);
                    section.appendChild(labelDiv);
                    section.appendChild(createComplexDataInput(key, value, template));
                } else {
                    // Simple data type
                    const group = document.createElement('div');
                    group.className = 'row mb-2 align-items-center';
                    
                    const labelCol = document.createElement('div');
                    labelCol.className = 'col-4';
                    const label = document.createElement('label');
                    label.className = 'mb-0';
                    label.textContent = key;
                    labelCol.appendChild(label);
                    
                    const inputCol = document.createElement('div');
                    inputCol.className = 'col-8';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.value = value;
                    input.onchange = () => {
                        logger.debug('variable-change', 'Variable value changed', {
                            template,
                            key,
                            newValue: input.value
                        });
                        updateVariable(template, key, input.value);
                        refreshPreview();
                    };
                    inputCol.appendChild(input);
                    
                    group.appendChild(labelCol);
                    group.appendChild(inputCol);
                    section.appendChild(group);
                }
            });
            
            variableList.appendChild(section);
        });
        
        // Update preview with all selected templates
        refreshPreview();
    })
    .catch(error => {
        logger.error('template-state', 'Failed to refresh template state', { error: error.message });
    });
}

// Update the refreshPreview function to include logging
function refreshPreview() {
    const nodePath = `${currentPath.family}/${currentPath.class}/${currentPath.node}`;
    
    // Create query string with selected templates
    const templateParams = currentPath.templates.map(t => `template=${encodeURIComponent(t)}`).join('&');
    const url = `{{ url_for("config.get_preview", node_path="") }}${nodePath}?${templateParams}`;
    
    logger.debug('preview', 'Refreshing preview', {
        nodePath,
        selectedTemplates: currentPath.templates,
        url
    });
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            document.getElementById('configPreview').textContent = data.content;
            logger.info('preview', 'Preview updated successfully');
        })
        .catch(error => {
            logger.error('preview', 'Failed to update preview', { error: error.message });
        });
}

// Update the updatePreviewOnly function
function updatePreviewOnly(template, key, value) {
    const nodePath = `${currentPath.family}/${currentPath.class}/${currentPath.node}`;
    
    logger.debug('preview-only', 'Updating preview only', {
        template,
        key,
        value,
        nodePath
    });
    
    fetch(`{{ url_for("config.get_variables", node_path="", template_name="") }}${nodePath}/${template}`)
        .then(response => response.json())
        .then(data => {
            // Create a copy of the current data
            const previewData = {...data};
            // Update only the interfaces for preview
            previewData[key] = value;
            
            logger.debug('preview-only', 'Updating variables for preview', {
                template,
                updatedData: previewData
            });
            
            // Update the variables first
            return fetch(`{{ url_for("config.get_variables", node_path="", template_name="") }}${nodePath}/${template}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    variable: key,
                    value: value,
                    preview_only: true
                })
            });
        })
        .then(() => {
            // Create query string with selected templates
            const templateParams = currentPath.templates.map(t => `template=${encodeURIComponent(t)}`).join('&');
            const url = `{{ url_for("config.get_preview", node_path="") }}${nodePath}?${templateParams}`;
            
            logger.debug('preview-only', 'Fetching updated preview', { url });
            
            return fetch(url);
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('configPreview').textContent = data.content;
            logger.info('preview-only', 'Preview updated successfully');
        })
        .catch(error => {
            logger.error('preview-only', 'Failed to update preview', { error: error.message });
        });
}

// Update variable value
function updateVariable(template, variable, value) {
    const nodePath = `${currentPath.family}/${currentPath.class}/${currentPath.node}`;
    fetch(`{{ url_for("config.get_variables", node_path="", template_name="") }}${nodePath}/${template}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            variable: variable,
            value: value
        })
    }).then(() => updatePreview());
}

// Update configuration preview
function updatePreview() {
    const nodePath = `${currentPath.family}/${currentPath.class}/${currentPath.node}`;
    
    // First get all variables for selected templates
    Promise.all(currentPath.templates.map(template =>
        fetch(`{{ url_for("config.get_variables", node_path="", template_name="") }}${nodePath}/${template}`)
            .then(response => response.json())
    )).then(() => {
        // Then get the preview
        return fetch(`{{ url_for("config.get_preview", node_path="") }}${nodePath}`);
    }).then(response => response.json())
    .then(data => {
        document.getElementById('configPreview').textContent = data.content;
    });
}

// Handle Git sync
document.getElementById('syncButton').onclick = () => {
    const button = document.getElementById('syncButton');
    const status = document.getElementById('syncStatus');
    
    button.disabled = true;
    status.textContent = 'Syncing...';
    
    fetch('{{ url_for("config.sync_repo") }}', {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            status.textContent = data.message;
            button.disabled = false;
            if (data.status === 'success') {
                loadStructure();
            }
        })
        .catch(error => {
            status.textContent = `Error: ${error}`;
            button.disabled = false;
        });
};

// Initial load
loadStructure();
</script>
{% endblock %} 